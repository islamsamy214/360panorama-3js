<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>360° Panorama Viewer with File Selector</title>
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: Arial, sans-serif;
    }
    canvas { 
      display: block;
    }
    #fileSelector {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 15px;
      border-radius: 5px;
      z-index: 100;
    }
    #instructions {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 100;
    }
    #startButton {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 10px 15px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 10px 0;
      cursor: pointer;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="fileSelector">
    <h2>360° Panorama Viewer</h2>
    <p>Select your 360° image file:</p>
    <input type="file" id="imageInput" accept="image/*">
    <button id="startButton">Load Panorama</button>
  </div>
  
  <div id="instructions">
    <p>Controls: Click and drag to look around. Scroll to zoom in/out.</p>
  </div>
  
  <!-- Load Three.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <script>
    // Initialize Three.js when the page loads
    let scene, camera, renderer;
    let isUserInteracting = false,
        onPointerDownMouseX = 0, onPointerDownMouseY = 0,
        lon = 0, onPointerDownLon = 0,
        lat = 0, onPointerDownLat = 0,
        phi = 0, theta = 0;
    
    // Initialize the scene
    function init() {
      // Create scene
      scene = new THREE.Scene();
      
      // Create camera
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 0.1;
      
      // Create renderer
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);
      
      // Add event listeners for panorama controls
      document.addEventListener('pointerdown', onPointerDown);
      document.addEventListener('pointermove', onPointerMove);
      document.addEventListener('pointerup', onPointerUp);
      document.addEventListener('wheel', onDocumentWheel);
      
      // Handle window resize
      window.addEventListener('resize', function() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
      
      // Start animation loop
      animate();
    }
    
    // Handle file selection and load the panorama
    document.getElementById('startButton').addEventListener('click', function() {
      const fileInput = document.getElementById('imageInput');
      
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        
        // Create URL for the selected file
        const imageURL = URL.createObjectURL(file);
        
        // Load the panorama
        loadPanorama(imageURL);
        
        // Hide the file selector
        document.getElementById('fileSelector').style.display = 'none';
      } else {
        alert('Please select an image file first.');
      }
    });
    
    // Load the panorama from the provided URL
    function loadPanorama(imageURL) {
      // Create a sphere geometry
      const geometry = new THREE.SphereGeometry(500, 60, 40);
      // Flip the geometry inside out
      geometry.scale(-1, 1, 1);
      
      // Load the panoramic image as a texture
      const texture = new THREE.TextureLoader().load(imageURL, function(tex) {
        console.log("Texture loaded successfully!");
      }, null, function(err) {
        console.error("Error loading texture:", err);
        alert("Error loading the image. Please try another file.");
        document.getElementById('fileSelector').style.display = 'block';
      });
      
      // Create material with the texture
      const material = new THREE.MeshBasicMaterial({
        map: texture
      });
      
      // Create mesh with geometry and material
      const sphere = new THREE.Mesh(geometry, material);
      scene.add(sphere);
    }
    
    // Controls functions
    function onPointerDown(event) {
      isUserInteracting = true;
      
      onPointerDownMouseX = event.clientX;
      onPointerDownMouseY = event.clientY;
      
      onPointerDownLon = lon;
      onPointerDownLat = lat;
    }
    
    function onPointerMove(event) {
      if (isUserInteracting) {
        lon = (onPointerDownMouseX - event.clientX) * 0.1 + onPointerDownLon;
        lat = (event.clientY - onPointerDownMouseY) * 0.1 + onPointerDownLat;
      }
    }
    
    function onPointerUp() {
      isUserInteracting = false;
    }
    
    function onDocumentWheel(event) {
      const fov = camera.fov + event.deltaY * 0.05;
      camera.fov = THREE.MathUtils.clamp(fov, 10, 75);
      camera.updateProjectionMatrix();
    }
    
    // Animation loop
    function animate() {
      requestAnimationFrame(animate);
      
      // Update camera position based on user interaction
      lat = Math.max(-85, Math.min(85, lat));
      phi = THREE.MathUtils.degToRad(90 - lat);
      theta = THREE.MathUtils.degToRad(lon);
      
      camera.lookAt(
        500 * Math.sin(phi) * Math.cos(theta),
        500 * Math.cos(phi),
        500 * Math.sin(phi) * Math.sin(theta)
      );
      
      renderer.render(scene, camera);
    }
    
    // Initialize the scene when the page loads
    init();
  </script>
</body>
</html>